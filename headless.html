<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Math Solver</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Roboto:wght@400;900&display=swap");
      * {
        font-family: "Roboto", sans-serif;
      }
      body {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: white;
        background-color: black;
      }
      #solutions {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      #input {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      h1 {
        font-weight: 900;
      }
    </style>
  </head>
  <body>
    <p id="finished" style="display: none"></p>
    <div id="input">
      <input type="file" id="file" />
    </div>
    <h1 id="searching"></h1>
    <div id="solutions"></div>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script
      src="https://cdn.socket.io/4.5.3/socket.io.min.js"
      integrity="sha384-WPFUvHkB1aHA5TDSZi6xtDgkF0wXJcIIxXhC6h8OT8EH3fC5PWro5pWJ1THjcfEi"
      crossorigin="anonymous"
    ></script>
    <script>
      let progress = {
        latex: 0,
        solution: 0,
        bing: 0,
      };
      const socket = io();

      let img = "";

      function readImage(input) {
        if (input.files && input.files[0]) {
          var FR = new FileReader();
          FR.onload = function (e) {
            //$('#base').text( e.target.result );
            socket.emit("locate", e.target.result);
            $("#input").hide();
            $("#searching").text("Locating Math Problems...");
            $("#searching").val(e.target.result);
          };
          FR.readAsDataURL(input.files[0]);
        }
      }

      $("#file").change(function () {
        readImage(this);
        $("#solutions").html(`<div id="loading1">Reading Image...</div>
    <div id="base1"></div>
    <div id="2loading1"></div>
    <div id="solution1"></div>
    <div id="graph1"></div>`);
      });

      socket.on("message", (msg) => {
        let id = msg.content.id ?? 1;
        $("#loading" + id).html("");
        $("#2loading" + id).html("");
        console.info("Message received...");
        console.log(msg);

        if (msg.type === "text") {
          $("#2loading" + id).html("Solving Problem...");
          $("#base" + id).html(msg.content.html);
          progress.latex -= 1;
          if (msg.content.latex == "error" || msg.content.latex == "") {
            $("#base" + id).html(``);
            $("#loading" + id).html(``);
            $("#2loading" + id).html(``);
            $("#solution" + id).html(``);
            if (
              progress.solution <= 0 &&
              progress.latex <= 0 &&
              progress.bing <= 0
            ) {
              $("#finished").show();
              $("#finished").text("Finished");
            }
          } else {
            $("#2loading" + id).html("");
            socket.emit("solve", { latex: msg.content.latex, id });
            progress.solution += 1;
          }
          if (msg.content.text == "") {
            $("#bingHeader" + id).html(`Could not find any text for bing`);
          } else {
            socket.emit("answer", { question: msg.content.text, id });
            $("#bingHeader" + id).html(msg.content.text);
            $("#bing" + id).html("Asking Bing for answers...");
            progress.bing += 1;
          }
        } else if (msg.type === "answer") {
          if (msg.content.result[0] == "Failed to reach Bing") {
            socket.emit("answer", { question: msg.content.question, id });
          } else {
            progress.bing -= 1;
            if (
              progress.solution <= 0 &&
              progress.latex <= 0 &&
              progress.bing <= 0
            ) {
              $("#finished").show();
              $("#finished").text("Finished");
            }
            $("#bing" + id).html(
              msg.content.result.map((e) => `<p>${e}</p>`).join("")
            );
          }
        } else if (msg.type === "solution") {
          let html = "";
          progress.solution -= 1;
          msg.content.solution.forEach((item) => {
            if (item.action) {
              html += `<h2>${item.action.actionName}</h2>` + "<br>" + item.html;
              item.action.templateSteps.forEach((item) => {
                html += `<h3>${item.templateName}</h3> <br>`;
                item.steps.forEach((item) => {
                  html += item.step + "<br>" + item.expression + "<br>";
                });
              });
            }
          });
          if (
            progress.solution <= 0 &&
            progress.latex <= 0 &&
            progress.bing <= 0 &&
            progress.bing <= 0
          ) {
            $("#finished").show();
            $("#finished").text("Finished");
          }
          $("#solution" + id).html(html);
        } else if (msg.type === "graph") {
          let html = "";
          if (msg.content && msg.content.graph) {
            if (msg.content.graph.length > 0) {
              html = "<h2>Graphs</h2>";
            }
            msg.content.graph.forEach((item) => {
              html += `<img src='${item.graphImageData}'>`;
            });
          }

          $("#graph" + id).html(html);
        } else if (msg.type === "locate") {
          $("#searching").text("");
          let id = String(Math.random()).replace("0.", "");
          let img = $("#searching").val();
          let html = `<h1>Math Answer</h1>
                    <div id="loading${id}">Reading Image...</div>
                    <div id="base${id}"></div>
                    <div id="2loading${id}"></div>
                    <div id="solution${id}"></div>
                    <div id="graph${id}"></div>
                    <h1>Bing Answer</h1>
                    <div id="bingHeader${id}"></div>
                    <div id="bing${id}"></div>`;
          socket.emit("read", { img, id });
          for (const entry in msg.content) {
            progress.latex += 1;
            let id = String(Math.random()).replace("0.", "");
            html += `<h1>Math Answer</h1>
                    <div id="loading${id}">Reading Image...</div>
                    <div id="base${id}"></div>
                    <div id="2loading${id}"></div>
                    <div id="solution${id}"></div>
                    <div id="graph${id}"></div>
                    <h1>Bing Answer</h1>
                    <div id="bingHeader${id}"></div>
                    <div id="bing${id}"></div>`;
            socket.emit("read", { img: msg.content[entry], id });
          }
          $("#solutions").html(html);
        }
      });
    </script>
  </body>
</html>
